# Work submitted to Climate Change & Biogeography: How vulnerable are mountaintop spore-dispersed plants to climate change in Iberian Peninsula?
#We are working at the 1Km scale in the Iberia Peninsula
#10 mountaintop bryophyte species were selected for this work

#PART I - Data Preparation

##Working directory and loading libraries

setwd("~/Helena/Rstudio/vulnerability_mountaintop_species")

library(raster)
library(biomod2)
library(ecospat)

##Topography indicators (slope, aspect, TPI, SPC, TRI, ...)

zonal(xxx, yyy, fun=function(x,...) c(MED=median(x,...), MAD=mad(x,...))) # xxx = name of the raster object (topography indicator)
                                                                          # yyy = name of the raster layer (in this example it will be the Iberian Peninsula grid)
                                                                          # This method allows to summarize the values in a Raster* object for each "zone" included in a RasterLayer.
                                                                          # zonal accepts summarizing functions (in argument fun) with single or multiple outputs.
                                                                                
##Bryophyte dataset 

occ<-read.table("And_Gri_Rac_PI_mountaintop.txt")

##Background dataset 

back<-read.table("back_pi.txt")

##Combining occurrence and background points

ob <- c(rep(1, nrow(occ)), rep(0, nrow(back)))
sdmdata <- data.frame(cbind(ob, rbind(occ, back)))


#PART II - Modelling method (fitting and prediction), model evaluation and combining model predictions

##Formating data

myRespName = "V1"                                #NAME OF COLUMN WITH SPECIES DATA.
xname = "V2"                                     #NAME OF COLUMN WITH 'X' COORDINATE.
yname = "V3"                                     #NAME OF COLUMN WITH 'Y' COORDINATE.


myResp <- as.numeric(sdmdata[,myRespName])       #READING PRESENCE AND ABSENCE COUNTS
myRespXY <- sdmdata[,c(xname,yname)]             #READING SPECIES XY COORDINATES


myExpl = stack(("XXXXXXXX"),                     #INSERT FILEPATHS TO EACH PREDICTOR VARIABLE HERE AND ADD MORE ENTRIES AS NEEDED.
               ("XXXXXXXX"),                              
               ("XXXXXXXX"))

projname = "he45bi50"                            #REPLACE XXXXXXXX WITH A NAME FOR YOUR PROJECTION
myExplProj_he45bi50 = stack(("XXXXXXXX"),        #INSERT FILEPATHS TO EACH PREDICTOR VARIABLE HERE AND ADD MORE ENTRIES AS NEEDED
                  ("XXXXXXXX"),                  #THESE MUST MATCH THE NAMES OF THE VARIABLE USED IN THE ORIGINAL RASTER STACK ABOVE
                   ("XXXXXXXX"),
                   ("XXXXXXXX"),
                   ("XXXXXXXX"))

myBiomodData <- BIOMOD_FormatingData(resp.var = myResp,          #SETTING UP INPUTS FOR MODELING 
                                     expl.var = myExpl, 
                                     resp.xy = myRespXY, 
                                     resp.name = myRespName)

##Modelling method: ESM Ensemble of Small Models - Ecospat package

### Calibration of simple bivariate models (see options)

myBiomodOption <- Print_Default_ModelingOptions()

my.ESM <- ecospat.ESM.Modeling( data=myBiomodData,
                                models=c("GLM","GBM","GAM","CTA","ANN","SRE","FDA","MARS","RF,MAXENT.Phillips"),
                                models.options=myBiomodOption,
                                NbRunEval=1,
                                DataSplit=70,
                                weighting.score=c("AUC","TSS","Boyce"),
                                parallel=F)

### Evaluation and average of simple bivariate models to ESMs (ensemble modelling)

my.ESM_EM <- ecospat.ESM.EnsembleModeling(my.ESM,weighting.score=c("SomersD"),threshold=0)

### Projection of simple bivariate models into new space or time

my.ESM_Proj_he45bi50 <- ecospat.ESM.Projection(ESM.modeling.output=my.ESM,
                                              new.env=myExplProj_he45bi50)

### Projection of calibrated ESMs into new space or time (ensemble modelling)

my.ESM_EM_Proj_he45bi50 <- ecospat.ESM.EnsembleProjection(ESM.prediction.output=my.ESM_Proj_he45bi50,
                                                        ESM.EnsembleModeling.output=my.ESM_EM)

#PART III - Report Generation (como imprimir os vários resultados e comparar as diferentes projeções com a distribuição actual)
