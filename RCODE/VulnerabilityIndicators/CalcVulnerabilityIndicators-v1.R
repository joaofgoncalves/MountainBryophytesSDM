
library(readxl)
library(raster)
library(dplyr)
library(tidyr)
library(rasterVis)
library(RColorBrewer)


nicheVarsPath <- "./OUT/nicheVars_v2.xlsx"

nv <- read_excel(nicheVarsPath)

spMods <- list.dirs("./OUT/MODS_v2", recursive = FALSE, full.names = TRUE)

spNames <- basename(spMods)

# pb <- txtProgressBar(min = 1, max = length(spNames), style = 3)
# 
# for(i in 1:length(spNames)){
#   
#   ensPath <- paste(spMods[i],"/proj_current/GeoTIFF/proj_current_",spNames[i],"_ensemble.tif",sep="")
#   binPath <- paste(spMods[i],"/proj_current/GeoTIFF/proj_current_",spNames[i],"_ensemble_TSSbin.tif",sep="")
#   
#   rstEns <- stack(ensPath)[[1]]
#   rstBin <- stack(binPath)[[1]]
#   
#   if(i==1){
#     rstEnsStack <- rstEns
#     rstBinStack <- rstBin
#   }else{
#     
#     # A small hack to correct for different extents in the projections...
#     if(!compareRaster(rstEns,rstEnsStack,stopiffalse = FALSE)){
#       message("\nResampling for rstEnsStack")
#       rstEns <- projectRaster(rstEns, rstEnsStack, method = 'ngb')
#     }
#     if(!compareRaster(rstBin,rstBinStack,stopiffalse = FALSE)){
#       message("\nResampling for rstBinStack")
#       rstBin <- projectRaster(rstBin, rstBinStack, method = 'ngb')
#     }
#     
#     rstEnsStack <- stack(rstEnsStack, rstEns)
#     rstBinStack <- stack(rstBinStack, rstBin)
#   }
#   
#   setTxtProgressBar(pb,i)
# }
#
#
# names(rstEnsStack) <- spNames
# names(rstBinStack) <- spNames
# 
# writeRaster(rstEnsStack,filename = "./OUT/rstEnsStack_multiSp_v2.grd")
# writeRaster(rstBinStack,filename = "./OUT/rstBinStack_multiSp_v2.grd")

rstEnsStack <- stack("./OUT/rstEnsStack_multiSp_v2.grd")
rstBinStack <- stack("./OUT/rstBinStack_multiSp_v2.grd")

rstEnsStack_sum <- calc(rstEnsStack, fun = sum) 
rstBinStack_sum <- calc(rstBinStack, fun = sum) 


i <- 0
pb <- txtProgressBar(min = 1, max = length(spNames), style = 3)
for(sp in spNames){
  i<- i + 1
  vi <- nv %>% 
    filter(spName == sp) %>% 
    select(distToAvgCentr, hv_svm) %>% 
    as.numeric
  
  #
  #
  # vi[1] distToAvgCentr
  # vi[2] hv_svm (used because has no negative values in contrast to the log version)
  
  NHCVI_bin_i <- 2*(rstBinStack[[i]] * vi[2]) - (rstBinStack[[i]] * vi[1])
  NHCVI_ens_i <- 2*(rstEnsStack[[i]] * vi[2]) - (rstEnsStack[[i]] * vi[1])
  
  if(i==1){
    NHCVI_bin_sum <- NHCVI_bin_i
    NHCVI_ens_sum <- NHCVI_ens_i
  }else{
    NHCVI_bin_sum <- NHCVI_bin_sum + NHCVI_bin_i
    NHCVI_ens_sum <- NHCVI_ens_sum + NHCVI_ens_i
  }
  setTxtProgressBar(pb,i)
}

NHCVI_bin <- NHCVI_bin_sum / rstBinStack_sum
NHCVI_ens <- NHCVI_ens_sum / rstEnsStack_sum

par(mfrow = c(2,2))
plot(rstBinStack_sum, main="Species richness")
plot(NHCVI_bin, main = "NHCVI bin. (norm. wt. sum)")
plot(NHCVI_ens, main = "NHCVI Hab Suitb. (norm. wt. sum)")


par(mfrow = c(2,2))
plot(rstBinStack_sum, main="Species richness")
plot(NHCVI_bin_sum, main = "NHCVI bin. (wt. sum)")
plot(NHCVI_ens_sum, main = "NHCVI Hab Suitb. (wt. sum)")

clSpear_NHCVI_bin_sum <- corLocal(x = rstBinStack_sum, y = NHCVI_bin_sum, 
                                  ngb=5, method=c("spearman"), test=FALSE)
clSpear_NHCVI_ens_sum <- corLocal(x = rstEnsStack_sum, y = NHCVI_ens_sum, 
                                  ngb=5, method=c("spearman"), test=FALSE)

plot(clSpear_NHCVI_bin_sum)
plot(clSpear_NHCVI_ens_sum)


#vals <- values(stack())
mapTheme <- rasterTheme(region=brewer.pal(8,"Greens"))
levelplot(rstBinStack_sum, margin=F, par.settings = mapTheme)

